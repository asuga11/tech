<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <title>–•–∞—è–≥ –±“Ø—Ä—Ç–≥—ç–ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">üìç –•–∞—è–≥–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç</h1>

    <!-- –•–∞–π–ª—Ç -->
    <div class="mb-4">
        <input id="searchInput" oninput="loadAddresses()" type="text" class="border p-2 w-full" placeholder="–•–∞—è–≥ —Ö–∞–π—Ö (—É–ª—Å, –∞–π–º–∞–≥, –≥—É–¥–∞–º–∂...)">
    </div>

    <!-- –•–∞—è–≥ –Ω—ç–º—ç—Ö —Ñ–æ—Ä–º -->
    <form id="addForm" class="grid grid-cols-2 gap-4 mb-6">
        <input name="country" class="border p-2" placeholder="–£–ª—Å">
        <input name="province" class="border p-2" placeholder="–ê–π–º–∞–≥ / –•–æ—Ç">
        <input name="district" class="border p-2" placeholder="–î“Ø“Ø—Ä—ç–≥">
        <input name="khoroo" class="border p-2" placeholder="–•–æ—Ä–æ–æ">
        <input name="street" class="border p-2" placeholder="–ì—É–¥–∞–º–∂">
        <input name="building" class="border p-2" placeholder="–ë–∞—Ä–∏–ª–≥–∞">
        <input name="apartment" class="border p-2" placeholder="–û—Ä–æ–Ω —Å—É—É—Ü">
        <input name="postalCode" class="border p-2" placeholder="–ó–∏–ø –∫–æ–¥">
        <input name="additionalInfo" class="col-span-2 border p-2" placeholder="–ù—ç–º—ç–ª—Ç –º—ç–¥—ç—ç–ª—ç–ª">
        <button type="submit" class="col-span-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">‚ûï –•–∞—è–≥ –Ω—ç–º—ç—Ö</button>
    </form>

    <!-- –•“Ø—Å–Ω—ç–≥—Ç -->
    <table class="w-full border border-gray-300 text-sm">
        <thead class="bg-gray-200">
        <tr>
            <th class="p-2 border">#</th>
            <th class="p-2 border">–£–ª—Å</th>
            <th class="p-2 border">–ê–π–º–∞–≥</th>
            <th class="p-2 border">–î“Ø“Ø—Ä—ç–≥</th>
            <th class="p-2 border">–•–æ—Ä–æ–æ</th>
            <th class="p-2 border">–ì—É–¥–∞–º–∂</th>
            <th class="p-2 border">–ë–∞—Ä–∏–ª–≥–∞</th>
            <th class="p-2 border">–û—Ä–æ–Ω —Å—É—É—Ü</th>
            <th class="p-2 border">–ó–∏–ø</th>
            <th class="p-2 border">üëÅÔ∏è</th>
            <th class="p-2 border">‚úèÔ∏è</th>
            <th class="p-2 border">‚ùå</th>
        </tr>
        </thead>
        <tbody id="address-table" class="bg-white">
        <!-- ”©–≥”©–≥–¥”©–ª —ç–Ω–¥ –æ—Ä–Ω–æ -->
        </tbody>
    </table>

    <!-- –•—É—É–¥–∞—Å–ª–∞—Ö —Ç–æ–≤—á -->
    <div class="flex justify-between items-center mt-4">
        <button onclick="prevPage()" class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-4 rounded">‚Üê ”®–º–Ω”©—Ö</button>
        <span id="page-indicator" class="text-gray-700"></span>
        <button onclick="nextPage()" class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-4 rounded">–î–∞—Ä–∞–∞—Ö ‚Üí</button>
    </div>
</div>

<!-- –ó–∞—Å–∞—Ö Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow-xl w-full max-w-xl relative">
        <h2 class="text-xl font-bold mb-4">üìÑ –•–∞—è–≥ –∑–∞—Å–∞—Ö</h2>
        <form id="editForm" class="grid grid-cols-2 gap-4">
            <input name="id" type="hidden">
            <input name="country" class="border p-2" placeholder="–£–ª—Å">
            <input name="province" class="border p-2" placeholder="–ê–π–º–∞–≥ / –•–æ—Ç">
            <input name="district" class="border p-2" placeholder="–î“Ø“Ø—Ä—ç–≥">
            <input name="khoroo" class="border p-2" placeholder="–•–æ—Ä–æ–æ">
            <input name="street" class="border p-2" placeholder="–ì—É–¥–∞–º–∂">
            <input name="building" class="border p-2" placeholder="–ë–∞—Ä–∏–ª–≥–∞">
            <input name="apartment" class="border p-2" placeholder="–û—Ä–æ–Ω —Å—É—É—Ü">
            <input name="postalCode" class="border p-2" placeholder="–ó–∏–ø –∫–æ–¥">
            <input name="additionalInfo" class="col-span-2 border p-2" placeholder="–ù—ç–º—ç–ª—Ç –º—ç–¥—ç—ç–ª—ç–ª">
            <div class="col-span-2 flex justify-between mt-4">
                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">üíæ –•–∞–¥–≥–∞–ª–∞—Ö</button>
                <button type="button" onclick="closeEditModal()" class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded">‚ùå –ë–æ–ª–∏—Ö</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentPage = 0;
    const size = 5;
    let totalPages = 1;

    function loadAddresses() {
        const search = document.getElementById("searchInput").value.trim().toLowerCase();

        fetch(`/api/addresses/paged?page=${currentPage}&size=${size}`)
            .then(res => res.json())
            .then(data => {
                const table = document.getElementById("address-table");
                table.innerHTML = "";

                const filtered = data.content.filter(addr => {
                    const str = `${addr.country} ${addr.province} ${addr.district} ${addr.khoroo} ${addr.street} ${addr.building} ${addr.apartment} ${addr.postalCode} ${addr.additionalInfo}`.toLowerCase();
                    return str.includes(search);
                });

                filtered.forEach((addr, index) => {
                    const addrJson = encodeURIComponent(JSON.stringify(addr));
                    table.innerHTML += `
              <tr class="border-t">
                <td class="p-2 border">${index + 1 + currentPage * size}</td>
                <td class="p-2 border">${addr.country || ''}</td>
                <td class="p-2 border">${addr.province || ''}</td>
                <td class="p-2 border">${addr.district || ''}</td>
                <td class="p-2 border">${addr.khoroo || ''}</td>
                <td class="p-2 border">${addr.street || ''}</td>
                <td class="p-2 border">${addr.building || ''}</td>
                <td class="p-2 border">${addr.apartment || ''}</td>
                <td class="p-2 border">${addr.postalCode || ''}</td>
                <td class="p-2 border">
                  <button onclick="viewAddress('${addrJson}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 rounded">üëÅÔ∏è</button>
                </td>
                <td class="p-2 border">
                  <button onclick="openEditModal('${addrJson}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 rounded">‚úèÔ∏è</button>
                </td>
                <td class="p-2 border">
                  <button onclick="deleteAddress(${addr.id})" class="bg-red-500 hover:bg-red-700 text-white px-2 rounded">X</button>
                </td>
              </tr>
            `;
                });

                totalPages = data.totalPages;
                document.getElementById("page-indicator").innerText = `–•—É—É–¥–∞—Å: ${currentPage + 1} / ${totalPages}`;
            });
    }

    function nextPage() {
        if (currentPage < totalPages - 1) {
            currentPage++;
            loadAddresses();
        }
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            loadAddresses();
        }
    }

    function deleteAddress(id) {
        if (confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) {
            fetch(`/api/addresses/${id}`, {
                method: 'DELETE'
            }).then(() => {
                loadAddresses();
            });
        }
    }

    document.getElementById("addForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            form.reset();
            loadAddresses();
        });
    });

    function openEditModal(addrJson) {
        const addr = JSON.parse(decodeURIComponent(addrJson));
        const form = document.getElementById('editForm');
        for (let key in addr) {
            if (form[key]) form[key].value = addr[key];
        }
        document.getElementById("editModal").classList.remove("hidden");
    }

    function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
    }

    document.getElementById("editForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value);
        const id = data.id;

        fetch(`/api/addresses/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            closeEditModal();
            loadAddresses();
        });
    });

    function viewAddress(addrJson) {
        const addr = JSON.parse(decodeURIComponent(addrJson));
        alert(`
–£–ª—Å: ${addr.country || ''}
–ê–π–º–∞–≥ / –•–æ—Ç: ${addr.province || ''}
–î“Ø“Ø—Ä—ç–≥: ${addr.district || ''}
–•–æ—Ä–æ–æ: ${addr.khoroo || ''}
–ì—É–¥–∞–º–∂: ${addr.street || ''}
–ë–∞—Ä–∏–ª–≥–∞: ${addr.building || ''}
–û—Ä–æ–Ω —Å—É—É—Ü: ${addr.apartment || ''}
–ó–∏–ø –∫–æ–¥: ${addr.postalCode || ''}
–ù—ç–º—ç–ª—Ç –º—ç–¥—ç—ç–ª—ç–ª: ${addr.additionalInfo || ''}
        `);
    }

    window.onload = loadAddresses;
</script>
</body>
</html>
